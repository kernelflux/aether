if (!project.hasProperty('publishArtifactId')) {
    throw new GradleException("publishArtifactId must be defined before applying maven-publish.gradle")
}
if (!project.hasProperty('publishVersion')) {
    throw new GradleException("publishVersion must be defined before applying maven-publish.gradle")
}

// Default configuration
def sGroupId = "com.kernelflux.mobile"
def sArtifactId = project.ext.publishArtifactId
def sVersion = project.ext.publishVersion
def sBundleName = project.hasProperty('publishBundleName')
        ? project.ext.publishBundleName
        : "${sArtifactId.replace('-', '_')}_bundle_v${sVersion}"


// Read configuration from private.properties or gradle properties
def privatePropsFile = project.rootProject.file("private.properties")
def sonatypeUsername = project.findProperty("sonatypeUsername")
def sonatypePassword = project.findProperty("sonatypePassword")

if (privatePropsFile.exists()) {
    def privateProps = new Properties()
    privateProps.load(new FileInputStream(privatePropsFile))
    // Read username and password from private.properties if not set in gradle properties
    if (!sonatypeUsername) {
        sonatypeUsername = privateProps.getProperty("sonatypeUsername")
    }
    if (!sonatypePassword) {
        sonatypePassword = privateProps.getProperty("sonatypePassword")
    }
}

mavenCentralUpload {
    uploadBundleName.set(sBundleName)
    if (sonatypeUsername) {
        username.set(sonatypeUsername)
    }
    if (sonatypePassword) {
        password.set(sonatypePassword)
    }
    groupId.set(sGroupId)
    artifactId.set(sArtifactId)
    version.set(sVersion)

    // Read signing configuration
    if (privatePropsFile.exists()) {
        def privateProps = new Properties()
        privateProps.load(new FileInputStream(privatePropsFile))
        def signingKeyFileProp = privateProps.getProperty("signingKeyFile")
        def signingPassProp = privateProps.getProperty("signingPass")

        if (signingKeyFileProp) {
            def keyFile = new File(signingKeyFileProp)
            def finalPath = keyFile.isAbsolute()
                    ? signingKeyFileProp
                    : new File(project.rootProject.projectDir, signingKeyFileProp).absolutePath
            def signingKeyFileObj = new File(finalPath)
            if (signingKeyFileObj.exists()) {
                signingKeyFile.set(finalPath)
                println("Maven Central Upload: signingKeyFile configured: ${finalPath} âœ“")
            } else {
                println("Maven Central Upload: signingKeyFile not found: ${finalPath}, signing will be disabled")
            }
        }

        if (signingPassProp) {
            signingPass.set(signingPassProp)
            println("Maven Central Upload: signingPass configured")
        }
    }

    // In Groovy DSL, need to explicitly create Action object
    pom.set(new Action<MavenPom>() {
        @Override
        void execute(MavenPom mavenPom) {
            mavenPom.name.set(sArtifactId)
            mavenPom.description.set("A Android modular development framework")
            mavenPom.url.set("https://github.com/kernelflux")
            mavenPom.licenses {
                license {
                    name.set("Apache License 2.0")
                    url.set("http://www.apache.org/licenses/LICENSE-2.0")
                }
            }
            mavenPom.developers {
                developer {
                    id.set("kernelflux")
                    name.set("0kt12")
                }
            }
            mavenPom.scm {
                url.set("https://github.com/kernelflux")
                connection.set("https://github.com/kernelflux")
                developerConnection.set("https://github.com/kernelflux")
            }
        }
    })
}